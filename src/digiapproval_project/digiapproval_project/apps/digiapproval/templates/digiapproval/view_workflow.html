{% extends "digiapproval/base.tpl.html" %}
{% block title %}{{workflow.spec.name}}{% endblock %}
{% block content %}
<p class="muted">Customer: {{workflow.customer.user.get_full_name}}<br/>
Approver: {{workflow.approver.get_full_name}}</p>

<div class="row">
  <div class="col-md-7">
    <h2>Tasks</h2>
    <ul>
      {% for task in tasks %}
      <li class="task task-{{task.state_name|lower}} {% if task.show_task_link %}task-actionable{% endif %}">
      <b>{{task.name}}</b> - {{task.state_name|title}}
      {% if task.actor %}
      - {{task.actor|title}}
      {% if task.show_task_link %}
      - <a href="{% url 'view_task' workflow.id task.uuid %}">Complete</a>
      {% endif %}
      {% if task.show_data_link %}
      - <a href="{% url 'view_task_data' task.uuid %}">View</a>
      {% endif %}
      {% endif %}
      </li>
      {% endfor %}
    </ul>
    {% ifequal user_type 'CUSTOMER' %}
      <form action="{% url 'update_workflow_state' workflow.id %}" method="POST" role="form">  
        {% csrf_token %}
        <input type="hidden" name="wf_state" value="CANCELLED"/>
        <button type="submit" name="submit" class="btn btn-default">Withdraw Application</button>
      </form>
    {% else %}{% endifequal %}
    
{% comment %}
    <h2>Debug Info</h2>
    <pre>
      {{workflow.workflow.spec.get_dump}}
    </pre>
    <pre>
      {{workflow.workflow.get_dump}}
    </pre>
{% endcomment %}
  </div>
  
  <div class="col-md-5">
    {% ifequal user_type 'APPROVER' %}
      {% include 'digiapproval/workflow_state.html' %}
    {% else %}{% endifequal %}      
    <h2>Recent Messages</h2>
    <form action="{% url 'view_workflow_messages' workflow.id %}" method="POST" role="form">
      {% csrf_token %}
      <label for="new_message">New Message:</label>
      <textarea name="new_message" class="form-control" rows="4"></textarea><br>
      <button type="submit" name="submit" class="btn btn-default">Post Message</button>
    </form>
    {% if messages %}
      {% for message in messages %}
        <blockquote>
          <pre>{{message.message}}</pre>
          <small>User: {{message.sender.get_full_name}}, Date: {{message.posted}}</small>
        </blockquote>
      {% endfor %}
      <a href="{% url 'view_workflow_messages' workflow.id%}">View all messages</a>
    {% else %}
    There are no messages associated with this workflow
    {% endif %}
  </div>
</div>
{% endblock content %}
